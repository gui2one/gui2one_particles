<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>gui2one Particles</title>
  </head>
  <body>
    <div id="parent-div"><h1>Hello</h1></div>

    <!-- <canvas id="pixi-canvas" width="500" height="500"></canvas> -->
    <script src="./gui2one_particles.js"></script>
    <script>
      const parent_div = document.getElementById("parent-div");
      let parent_rect = parent_div.getBoundingClientRect();

      let timer;
      let mouseStopped = true;
      let canvas = document.createElement("canvas");
      parent_div.appendChild(canvas);
      canvas.style.position = "absolute";
      canvas.style.left = "0px";
      canvas.style.top = "0px";
      canvas.style.width = "100%";
      canvas.style.height = "100%";
      canvas.style.pointerEvents = "none";

      const pixi_canvas = document.getElementById("pixi-canvas");

      let width = parent_rect.width;
      let height = parent_rect.height;
      const app = new PIXI.Application({
        width: width,
        height: height,
        view: canvas,
        transparent: true,
      });

      const ps = new ParticleSystem();
      let gravity = new ParticleForceDirectional();
      gravity.setDirection(new Vector2(0, 50));
      gravity.treat_as_wind = true;
      ps.forces.push(gravity);

      let noise_force = new ParticleForceNoise();
      noise_force.setSeed(Math.random());
      noise_force.power = 0.25;
      ps.forces.push(noise_force);

      let point_force = new ParticleForcePoint();

      point_force.position.x = 100;
      point_force.position.y = 100;
      ps.forces.push(point_force);
      let blur = new PIXI.filters.BlurFilter();
      blur.blur = 6;

      let line_emitter = new LineEmitter();
      line_emitter.addTexture("snowflakes/snowflake_small.1.png");
      line_emitter.addTexture("snowflakes/snowflake_small.2.png");
      line_emitter.addTexture("snowflakes/snowflake_small.3.png");
      line_emitter.width = 250;

      line_emitter.min_particles_scale = 0.2;
      line_emitter.max_particles_scale = 0.5;
      line_emitter.rand_vel_amount = 0.0;
      line_emitter.amount_per_second = 20;
      line_emitter.limit_num = 5000;

      ps.emitters.push(line_emitter);
      let bloom = new AdvancedBloomFilter({
        bloomScale: 1.0,
        threshold: 0.2,
        brightness: 1.0,
        // kernels: 8,
        blur: 5,
        resolution: 1,
      });
      ps.emitters[0].pixi_container.filters = [bloom];
      app.stage.addChild(ps.emitters[0].pixi_container);
      // ps.emitters[0].startEmission();

      app.ticker.add(() => {});

      function animate() {
        let line_emitter = ps.emitters[0];
        line_emitter.width = width * 1.1;
        line_emitter.position.x = width / 2 - line_emitter.width / 2;
        line_emitter.position.y = -10;

        // console.log(mouseStopped);
        if (mouseStopped) point_force.power = 0;
        else point_force.power = 1.0;
        ps.update();

        let delta = ps.clock.getDeltaMillis();
        let fps = 1000 / delta;

        requestAnimationFrame(animate);
      }

      animate();

      window.addEventListener("resize", () => {
        parent_rect = parent_div.getBoundingClientRect();
        width = parent_rect.width;
        height = parent_rect.height;
        app.renderer.resize(width, height);
      });

      window.addEventListener("mousedown", function (event) {
        line_emitter.stopEmission();
      });

      window.addEventListener("mouseup", function (event) {
        line_emitter.startEmission();
      });
      parent_div.addEventListener("mousemove", function (event) {
        // console.log(event);
        point_force.position.x = event.layerX;
        point_force.position.y = event.layerY;
        mouseStopped = false;
        clearTimeout(timer);
        timer = setTimeout(() => {
          mouseStopped = true;
        }, 300);
      });
    </script>
  </body>
</html>
